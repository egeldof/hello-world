<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wijntest Simulator</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 2rem;
  }
  h1 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 0.3rem;
    color: #c4a35a;
  }
  .subtitle {
    text-align: center;
    color: #fff;
    margin-bottom: 2rem;
    font-size: 0.9rem;
    font-weight: 900;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.5;
  }
  .panels {
    display: flex;
    gap: 2rem;
    max-width: 1100px;
    margin: 0 auto;
    flex-wrap: wrap;
  }
  .panel {
    background: #16213e;
    border-radius: 12px;
    padding: 1.5rem;
    flex: 1;
    min-width: 320px;
    border: 1px solid #0f3460;
  }
  .panel h2 {
    color: #c4a35a;
    font-size: 1.15rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid #0f3460;
    padding-bottom: 0.5rem;
  }
  button {
    background: #c4a35a;
    color: #1a1a2e;
    border: none;
    padding: 0.6rem 1.4rem;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #d4b76a; }
  button:active { background: #b4953a; }
  input[type="number"] {
    background: #0f3460;
    border: 1px solid #1a4a8a;
    color: #e0e0e0;
    padding: 0.5rem 0.7rem;
    border-radius: 6px;
    font-size: 1rem;
    width: 100px;
    text-align: center;
  }
  input[type="number"]:focus { outline: 2px solid #c4a35a; }

  /* Bottles */
  .bottles {
    display: flex;
    justify-content: center;
    gap: 1.2rem;
    margin: 1.2rem 0;
  }
  .bottle {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
  }
  .bottle-icon {
    font-size: 2.5rem;
    transition: transform 0.3s;
  }
  .bottle-icon.highlight { transform: scale(1.25); }
  .bottle-label {
    font-size: 0.75rem;
    color: #888;
  }
  .bottle-count {
    font-size: 1.1rem;
    font-weight: 700;
    min-height: 1.5em;
  }
  .bottle-count.correct { color: #4ecca3; }
  .bottle-count.wrong { color: #dd3333; }

  /* People grid */
  .people-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.4rem;
    margin: 1rem 0;
  }
  .person {
    text-align: center;
    padding: 0.3rem;
    border-radius: 6px;
    font-size: 0.8rem;
    transition: background 0.3s;
  }
  .person .icon { font-size: 1.4rem; }
  .person.correct { background: rgba(78, 204, 163, 0.2); }
  .person.wrong { background: rgba(224, 108, 117, 0.15); }

  /* Result */
  .result-box {
    text-align: center;
    padding: 1rem;
    background: #0f3460;
    border-radius: 8px;
    margin-top: 1rem;
    font-size: 1.1rem;
  }
  .result-box .big {
    font-size: 2rem;
    font-weight: 700;
    color: #4ecca3;
  }

  /* Histogram */
  .histogram-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  .histogram-container {
    background: #0f3460;
    border-radius: 8px;
    padding: 1.2rem;
    padding-right: 3rem;
    margin-top: 1rem;
  }
  .histogram-bars-wrapper {
    position: relative;
  }
  .histogram-bars {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 220px;
    padding-top: 1rem;
    position: relative;
  }
  .cdf-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }
  .cdf-overlay polyline {
    fill: none;
    stroke: #dd3333;
    stroke-width: 2.5;
    stroke-linejoin: round;
    stroke-linecap: round;
  }
  .cdf-overlay polyline.cdf-green {
    stroke: #4cdf7a;
  }
  .cdf-overlay circle {
    fill: #dd3333;
  }
  .cdf-overlay circle.cdf-green {
    fill: #4cdf7a;
  }
  .cdf-axis-label {
    font-size: 0.7rem;
    color: #dd3333;
    position: absolute;
    right: 0;
  }
  .cdf-axis {
    position: absolute;
    right: -32px;
    top: 1rem;
    bottom: 0;
    width: 30px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    font-size: 0.65rem;
    font-weight: 900;
    color: #dd3333;
    text-align: right;
    pointer-events: none;
  }
  .bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
  }
  .bar {
    width: 100%;
    max-width: 40px;
    background: #c4a35a;
    border-radius: 3px 3px 0 0;
    transition: height 0.4s ease;
    min-height: 0;
    position: relative;
  }
  .bar.significant { background: #dd3333; }
  .bar.significant:hover { background: #ee5555; }
  .bar:hover { background: #d4b76a; }
  .bar-value {
    font-size: 0.7rem;
    color: #fff;
    font-weight: 900;
    margin-bottom: 2px;
    min-height: 1em;
  }
  .bar-label {
    font-size: 0.75rem;
    color: #fff;
    font-weight: 900;
    margin-top: 4px;
  }
  .stats {
    display: flex;
    gap: 1.5rem;
    margin-top: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .stat {
    text-align: center;
  }
  .stat-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: #c4a35a;
  }
  .stat-label {
    font-size: 0.75rem;
    font-weight: 900;
    color: #fff;
  }
  .expected-line {
    font-size: 0.8rem;
    color: #c4a35a;
    font-weight: 900;
    text-align: center;
    margin-top: 0.8rem;
  }
  .significance-line {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dd3333;
    z-index: 10;
  }
  .significance-label {
    position: absolute;
    top: -2px;
    font-size: 0.7rem;
    color: #dd3333;
    white-space: nowrap;
    font-weight: 600;
    transform: translateX(-50%);
  }
  .legend {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-top: 0.6rem;
    font-size: 0.75rem;
    font-weight: 900;
    color: #fff;
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .legend-swatch {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }
  .cdf-overlay text {
    fill: #dd3333;
    font-size: 9px;
    font-weight: 700;
    font-family: 'Segoe UI', system-ui, sans-serif;
  }
  .cdf-overlay text.cdf-green {
    fill: #4cdf7a;
    text-anchor: middle;
  }

  /* Mobile: phones */
  @media (max-width: 600px) {
    body { padding: 0.8rem; }
    h1 { font-size: 1.4rem; }
    .subtitle { font-size: 0.8rem; margin-bottom: 1.2rem; }
    .panels { gap: 1rem; }
    .panel { min-width: unset; padding: 1rem; }
    .bottles { gap: 0.5rem; }
    .bottle-icon { font-size: 1.8rem; }
    .bottle-label { font-size: 0.65rem; }
    .bottle-count { font-size: 0.9rem; }
    .people-grid { grid-template-columns: repeat(4, 1fr); gap: 0.3rem; }
    .person .icon { font-size: 1.2rem; }
    .person { font-size: 0.7rem; }
    .result-box { font-size: 0.95rem; }
    .result-box .big { font-size: 1.5rem; }
    .histogram-container { padding: 0.8rem; padding-right: 2.5rem; }
    .histogram-bars { height: 180px; }
    .bar-value { font-size: 0.55rem; }
    .bar-label { font-size: 0.6rem; }
    .stats { gap: 0.8rem; }
    .stat-value { font-size: 1rem; }
    .stat-label { font-size: 0.65rem; }
    .expected-line { font-size: 0.7rem; }
    .legend { gap: 0.8rem; font-size: 0.65rem; }
    .significance-label { font-size: 0.6rem; }
    .cdf-overlay text { font-size: 7px; }
    .cdf-axis { font-size: 0.55rem; right: -28px; }
    .histogram-controls { gap: 0.5rem; }
    button { padding: 0.5rem 1rem; font-size: 0.9rem; }
    input[type="number"] { width: 80px; font-size: 0.9rem; padding: 0.4rem 0.5rem; }
  }

  /* Formula section */
  .formula-section {
    max-width: 700px;
    margin: 3rem auto 0;
    padding: 1.5rem;
    background: rgba(255,255,255,0.04);
    border-radius: 12px;
    border: 1px solid rgba(196,163,90,0.2);
  }
  .formula-section h2 {
    text-align: center;
    color: #c4a35a;
    font-size: 1.4rem;
    margin-bottom: 1rem;
  }
  .formula-section h3 {
    color: #c4a35a;
    font-size: 1.1rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }
  .formula-intro {
    color: #e0e0e0;
    font-size: 0.85rem;
    line-height: 1.6;
    margin-bottom: 0.8rem;
  }
  .formula-legend {
    color: #e0e0e0;
    font-size: 0.85rem;
    line-height: 1.8;
    margin: 0 0 1rem 1.2rem;
  }
  .formula-box {
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    padding: 0.8rem 1.2rem;
    margin: 0.8rem 0;
    text-align: center;
  }
  .formula {
    color: #fff;
    font-size: 1rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
  }
  .table-wrapper {
    overflow-x: auto;
    margin-top: 0.8rem;
  }
  .prob-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }
  .prob-table th {
    background: rgba(196,163,90,0.2);
    color: #c4a35a;
    font-weight: 900;
    padding: 0.5rem 0.8rem;
    text-align: center;
    border-bottom: 2px solid rgba(196,163,90,0.3);
  }
  .prob-table td {
    padding: 0.4rem 0.8rem;
    text-align: center;
    color: #e0e0e0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .prob-table tr:hover td {
    background: rgba(255,255,255,0.05);
  }
  .prob-table .sig-row td {
    color: #4cdf7a;
    font-weight: 700;
  }
  .sig-text {
    color: #4cdf7a;
    font-weight: 700;
  }

  /* Tablet: iPad etc */
  @media (min-width: 601px) and (max-width: 1024px) {
    body { padding: 1.2rem; }
    .panels { flex-direction: column; max-width: 700px; }
    .panel { min-width: unset; }
    .people-grid { grid-template-columns: repeat(8, 1fr); }
  }
</style>
</head>
<body>

<h1>Wijntest Simulator</h1>
<p class="subtitle">Dit is een random test waarbij 16 deelnemers uit 5 flessen wijn moeten kiezen. E&eacute;n van de 5 flessen is een hele goede en dure wijn en de andere 4 zijn hele simpele goedkope wijnen. In de test wordt weergegeven wat de uitkomst per test zou zijn als de deelnemers absoluut geen kennis van wijn hebben. Als 7 of meer deelnemers de dure wijn kiezen, dan is het statistisch gezien met een kans van ruim 97% dat er &eacute;&eacute;n of meerdere wijnkenners onder de deelnemers zijn. Gemiddeld zullen 3,19 deelnemers de juiste wijn kiezen puur random zonder enige wijnkennis. Zie de formules onderaan deze pagina. Je kan de testen zelf uitvoeren als Enkele Test of als Serie Test.</p>

<div class="panels">

  <!-- Single test panel -->
  <div class="panel">
    <h2>Enkele test</h2>
    <button id="btnSingle" onclick="runSingle()">Test uitvoeren</button>

    <div class="bottles" id="bottles">
      <div class="bottle">
        <div class="bottle-icon">&#127863;</div>
        <div class="bottle-label">Goedkoop 1</div>
        <div class="bottle-count" id="bc0"></div>
      </div>
      <div class="bottle">
        <div class="bottle-icon">&#127863;</div>
        <div class="bottle-label">Goedkoop 2</div>
        <div class="bottle-count" id="bc1"></div>
      </div>
      <div class="bottle">
        <div class="bottle-icon">&#127863;</div>
        <div class="bottle-label">Goedkoop 3</div>
        <div class="bottle-count" id="bc2"></div>
      </div>
      <div class="bottle">
        <div class="bottle-icon">&#127863;</div>
        <div class="bottle-label">Goedkoop 4</div>
        <div class="bottle-count" id="bc3"></div>
      </div>
      <div class="bottle">
        <div class="bottle-icon" id="expensiveIcon">&#127942;</div>
        <div class="bottle-label" style="color:#c4a35a;">Duur</div>
        <div class="bottle-count correct" id="bc4"></div>
      </div>
    </div>

    <div class="people-grid" id="peopleGrid"></div>

    <div class="result-box" id="resultBox" style="display:none;">
      <div class="big" id="resultCount"></div>
      <div id="resultText"></div>
    </div>
  </div>

  <!-- Batch test panel -->
  <div class="panel">
    <h2>Serie tests</h2>
    <div class="histogram-controls">
      <label>Aantal tests:
        <input type="number" id="batchCount" value="1000" min="1" max="100000">
      </label>
      <button id="btnBatch" onclick="runBatch()">Serie uitvoeren</button>
    </div>

    <div class="histogram-container" id="histContainer" style="display:none;">
      <div class="histogram-bars-wrapper">
        <div class="histogram-bars" id="histBars"></div>
        <svg class="cdf-overlay" id="cdfOverlay" preserveAspectRatio="none"></svg>
        <div class="cdf-axis" id="cdfAxis"></div>
      </div>
      <div class="stats" id="statsRow"></div>
      <div class="expected-line" id="expectedLine"></div>
    </div>
  </div>

</div>

<script>
const NUM_WINES = 5;
const EXPENSIVE = 4; // index of expensive wine
const NUM_PEOPLE = 16;

// Initialize people grid
function initPeopleGrid() {
  const grid = document.getElementById('peopleGrid');
  grid.innerHTML = '';
  for (let i = 0; i < NUM_PEOPLE; i++) {
    const div = document.createElement('div');
    div.className = 'person';
    div.innerHTML = `<div class="icon">&#128100;</div><div class="choice" id="p${i}"></div>`;
    div.id = `person${i}`;
    grid.appendChild(div);
  }
}
initPeopleGrid();

function simulate() {
  const choices = [];
  for (let i = 0; i < NUM_PEOPLE; i++) {
    choices.push(Math.floor(Math.random() * NUM_WINES));
  }
  return choices;
}

function runSingle() {
  const choices = simulate();
  const counts = new Array(NUM_WINES).fill(0);
  let correct = 0;

  choices.forEach((c, i) => {
    counts[c]++;
    const el = document.getElementById(`person${i}`);
    const choiceLabel = c === EXPENSIVE ? 'Duur' : `G${c + 1}`;
    const choiceIcon = c === EXPENSIVE ? '\u{1F3C6}' : '\u{1F377}';
    el.querySelector('.icon').textContent = choiceIcon;
    document.getElementById(`p${i}`).textContent = choiceLabel;
    if (c === EXPENSIVE) {
      el.className = 'person correct';
      correct++;
    } else {
      el.className = 'person wrong';
    }
  });

  // Update bottle counts
  for (let i = 0; i < NUM_WINES; i++) {
    const el = document.getElementById(`bc${i}`);
    el.textContent = counts[i] > 0 ? counts[i] : '';
    if (i === EXPENSIVE) {
      el.className = 'bottle-count correct';
    } else {
      el.className = counts[i] > 0 ? 'bottle-count wrong' : 'bottle-count';
    }
  }

  // Highlight expensive bottle
  document.getElementById('expensiveIcon').className =
    counts[EXPENSIVE] > 0 ? 'bottle-icon highlight' : 'bottle-icon';

  // Show result
  const box = document.getElementById('resultBox');
  box.style.display = 'block';
  document.getElementById('resultCount').textContent = `${correct} / ${NUM_PEOPLE}`;
  document.getElementById('resultText').textContent =
    `${correct} ${correct === 1 ? 'persoon heeft' : 'personen hebben'} de dure wijn gekozen (${(correct / NUM_PEOPLE * 100).toFixed(1)}%)`;
}

function runBatch() {
  const n = Math.min(Math.max(parseInt(document.getElementById('batchCount').value) || 1000, 1), 100000);
  document.getElementById('batchCount').value = n;

  // Distribution: how many times did X people choose the expensive wine
  const dist = new Array(NUM_PEOPLE + 1).fill(0); // 0..16

  for (let t = 0; t < n; t++) {
    let correct = 0;
    for (let i = 0; i < NUM_PEOPLE; i++) {
      if (Math.floor(Math.random() * NUM_WINES) === EXPENSIVE) correct++;
    }
    dist[correct]++;
  }

  // Stats
  let totalCorrect = 0;
  let maxCount = 0;
  let modeVal = 0;
  for (let i = 0; i <= NUM_PEOPLE; i++) {
    totalCorrect += i * dist[i];
    if (dist[i] > maxCount) { maxCount = dist[i]; modeVal = i; }
  }
  const mean = totalCorrect / n;
  let variance = 0;
  for (let i = 0; i <= NUM_PEOPLE; i++) {
    variance += dist[i] * (i - mean) ** 2;
  }
  variance /= n;
  const stddev = Math.sqrt(variance);

  // Render histogram
  const container = document.getElementById('histContainer');
  container.style.display = 'block';
  const barsEl = document.getElementById('histBars');
  barsEl.innerHTML = '';

  // Calculate significance threshold (p < 0.05, one-tailed binomial test)
  const p = 1 / NUM_WINES;
  const sigThreshold = binomialThreshold(NUM_PEOPLE, p, 0.05);

  for (let i = 0; i <= NUM_PEOPLE; i++) {
    const pct = maxCount > 0 ? (dist[i] / maxCount) * 100 : 0;
    const group = document.createElement('div');
    group.className = 'bar-group';
    group.style.position = 'relative';

    const valEl = document.createElement('div');
    valEl.className = 'bar-value';
    valEl.textContent = dist[i] > 0 ? dist[i] : '';

    const bar = document.createElement('div');
    bar.className = i >= sigThreshold ? 'bar significant' : 'bar';
    bar.style.height = pct + '%';
    bar.title = `${i} personen: ${dist[i]} keer (${(dist[i] / n * 100).toFixed(2)}%)${i >= sigThreshold ? ' — significant!' : ''}`;

    const label = document.createElement('div');
    label.className = 'bar-label';
    label.textContent = i;

    group.appendChild(valEl);
    group.appendChild(bar);
    group.appendChild(label);

    // Add significance line before the threshold bar
    if (i === sigThreshold) {
      const line = document.createElement('div');
      line.className = 'significance-line';
      line.style.left = '-2px';
      const lineLabel = document.createElement('div');
      lineLabel.className = 'significance-label';
      lineLabel.style.left = '-2px';
      lineLabel.textContent = 'p < 0.05';
      group.appendChild(line);
      group.appendChild(lineLabel);
    }

    barsEl.appendChild(group);
  }

  // Stats row
  document.getElementById('statsRow').innerHTML = `
    <div class="stat"><div class="stat-value">${n.toLocaleString()}</div><div class="stat-label">Tests</div></div>
    <div class="stat"><div class="stat-value">${mean.toFixed(2)}</div><div class="stat-label">Gemiddelde</div></div>
    <div class="stat"><div class="stat-value">${modeVal}</div><div class="stat-label">Modus</div></div>
    <div class="stat"><div class="stat-value">${stddev.toFixed(2)}</div><div class="stat-label">Std. dev.</div></div>
  `;

  // Count how many tests were significant
  let sigCount = 0;
  for (let i = sigThreshold; i <= NUM_PEOPLE; i++) sigCount += dist[i];

  const expected = NUM_PEOPLE / NUM_WINES;
  document.getElementById('expectedLine').innerHTML =
    `Verwachte waarde (bij puur toeval): ${expected.toFixed(1)} van de ${NUM_PEOPLE} kiezen de dure wijn (${(100 / NUM_WINES).toFixed(0)}% kans per persoon)<br>` +
    `<span style="color:#dd3333;">Significantiegrens (p &lt; 0.05): ${sigThreshold}+ personen — ` +
    `<strong>${sigCount.toLocaleString()}</strong> van ${n.toLocaleString()} tests (${(sigCount / n * 100).toFixed(1)}%) was significant</span>`;

  // Legend
  let legendEl = document.getElementById('histLegend');
  if (!legendEl) {
    legendEl = document.createElement('div');
    legendEl.id = 'histLegend';
    legendEl.className = 'legend';
    container.appendChild(legendEl);
  }
  legendEl.innerHTML = `
    <div class="legend-item"><div class="legend-swatch" style="background:#c4a35a;"></div> Toeval (niet significant)</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#dd3333;"></div> Significant (p &lt; 0.05)</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#dd3333; width:2px; height:12px;"></div> Significantiegrens</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#dd3333; height:2px; border-radius:0;"></div> P(X &ge; k) — kans op toeval</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#4cdf7a; height:2px; border-radius:0;"></div> 1 &minus; P(X &ge; k) — kans op wijnkennis</div>
  `;

  // Draw reverse CDF (survival function) overlay
  drawSurvivalCurve(dist, n);
}

function drawSurvivalCurve(dist, n) {
  const svg = document.getElementById('cdfOverlay');
  const barsEl = document.getElementById('histBars');
  const axisEl = document.getElementById('cdfAxis');

  // Wait for layout to settle
  requestAnimationFrame(() => {
    const rect = barsEl.getBoundingClientRect();
    const svgW = rect.width;
    const svgH = rect.height;
    const paddingTop = parseFloat(getComputedStyle(barsEl).paddingTop) || 0;
    const chartH = svgH - paddingTop;

    svg.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);
    svg.innerHTML = '';

    // Calculate survival function: P(X >= k)
    const survival = [];
    let cumRight = 0;
    for (let k = NUM_PEOPLE; k >= 0; k--) {
      cumRight += dist[k];
      survival[k] = cumRight / n;
    }

    // Get bar-group positions for x coordinates
    const groups = barsEl.querySelectorAll('.bar-group');
    const points = [];
    const pointData = [];
    groups.forEach((g, i) => {
      const gRect = g.getBoundingClientRect();
      const x = gRect.left - rect.left + gRect.width / 2;
      const y = paddingTop + (1 - survival[i]) * chartH;
      points.push(`${x},${y}`);
      pointData.push({ x, y, val: survival[i] });

      // Add dot
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', x);
      circle.setAttribute('cy', y);
      circle.setAttribute('r', 3);
      svg.appendChild(circle);
    });

    // Add value labels at each point
    pointData.forEach((pt, i) => {
      const pctVal = pt.val * 100;
      if (pctVal < 0.05) return; // skip zero and near-zero clutter
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', pt.x);
      text.setAttribute('y', pt.y - 8);
      text.textContent = pctVal >= 1 ? pctVal.toFixed(0) + '%' : pctVal.toFixed(1) + '%';
      svg.appendChild(text);
    });

    // Draw red polyline (survival)
    const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
    polyline.setAttribute('points', points.join(' '));
    svg.appendChild(polyline);

    // Calculate and draw green CDF: P(wine knowledge) = 1 - P(X >= k)
    const greenPoints = [];
    const greenData = [];
    groups.forEach((g, i) => {
      const gRect = g.getBoundingClientRect();
      const x = gRect.left - rect.left + gRect.width / 2;
      const wineKnowledge = 1 - survival[i];
      const y = paddingTop + (1 - wineKnowledge) * chartH;
      greenPoints.push(`${x},${y}`);
      greenData.push({ x, y, val: wineKnowledge });

      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', x);
      circle.setAttribute('cy', y);
      circle.setAttribute('r', 3);
      circle.classList.add('cdf-green');
      svg.appendChild(circle);
    });

    // Green value labels
    greenData.forEach((pt) => {
      const pctVal = pt.val * 100;
      if (pctVal < 0.05 || pctVal > 99.95) return;
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', pt.x + 12);
      text.setAttribute('y', pt.y + 14);
      text.classList.add('cdf-green');
      text.textContent = pctVal >= 1 ? pctVal.toFixed(0) + '%' : pctVal.toFixed(1) + '%';
      svg.appendChild(text);
    });

    // Green polyline
    const greenPolyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
    greenPolyline.setAttribute('points', greenPoints.join(' '));
    greenPolyline.classList.add('cdf-green');
    svg.appendChild(greenPolyline);

    // Y-axis labels for CDF
    axisEl.innerHTML = '';
    [1, 0.5, 0].forEach(v => {
      const label = document.createElement('div');
      label.textContent = (v * 100).toFixed(0) + '%';
      axisEl.appendChild(label);
    });
  });
}

// Calculate the smallest k where P(X >= k) < alpha using binomial CDF
function binomialThreshold(n, p, alpha) {
  // Compute P(X >= k) = 1 - P(X <= k-1) for increasing k
  let cumulative = 0;
  for (let k = 0; k <= n; k++) {
    cumulative += binomialPMF(n, k, p);
    if (1 - cumulative < alpha) return k + 1;
  }
  return n + 1;
}

function binomialPMF(n, k, p) {
  // log-space to avoid overflow
  let logP = 0;
  for (let i = 0; i < k; i++) {
    logP += Math.log(n - i) - Math.log(i + 1);
  }
  logP += k * Math.log(p) + (n - k) * Math.log(1 - p);
  return Math.exp(logP);
}

// Run batch test automatically on page load
runBatch();

// Generate probability table
function generateProbTable() {
  const n = 16, p = 1/5;
  const tbody = document.getElementById('prob-tbody');
  let cumGe = 1; // P(X >= 0) = 1
  for (let k = 0; k <= n; k++) {
    const pmf = binomialPMF(n, k, p);
    const row = document.createElement('tr');
    const isSignificant = k >= 7;
    if (isSignificant) row.classList.add('sig-row');
    const wineKnowledge = (1 - cumGe) * 100;
    row.innerHTML =
      '<td>' + k + '</td>' +
      '<td>' + (pmf * 100).toFixed(4) + '%</td>' +
      '<td>' + (cumGe * 100).toFixed(4) + '%</td>' +
      '<td>' + wineKnowledge.toFixed(4) + '%</td>';
    tbody.appendChild(row);
    cumGe -= pmf;
  }
}
</script>

<div class="formula-section">
  <h2>Kansberekening</h2>
  <p class="formula-intro">De kans dat exact <em>k</em> van de 16 deelnemers de juiste (dure) wijn kiezen, puur op basis van toeval (1 uit 5), volgt de <strong>binomiale verdeling</strong>:</p>

  <div class="formula-box">
    <p class="formula">P(X = k) = C(16, k) &times; (1/5)<sup>k</sup> &times; (4/5)<sup>16 &minus; k</sup></p>
  </div>

  <p class="formula-intro">Waarbij:</p>
  <ul class="formula-legend">
    <li><strong>n = 16</strong> &mdash; het aantal deelnemers</li>
    <li><strong>p = 1/5 = 0,20</strong> &mdash; de kans om random de juiste wijn te kiezen</li>
    <li><strong>k</strong> &mdash; het aantal deelnemers dat de dure wijn kiest (0 t/m 16)</li>
    <li><strong>C(16, k)</strong> &mdash; het aantal combinaties ("16 boven k")</li>
  </ul>

  <p class="formula-intro">De <strong>verwachte waarde</strong> (gemiddelde) is:</p>
  <div class="formula-box">
    <p class="formula">E(X) = n &times; p = 16 &times; 1/5 = <strong>3,20</strong></p>
  </div>

  <h3>Kanstabel</h3>
  <p class="formula-intro">Hieronder de kans per uitkomst. <span class="sig-text">Groen gemarkeerde rijen</span> (k &ge; 7) zijn statistisch significant (p &lt; 0,05): de kans dat dit puur toeval is, is kleiner dan 5%.</p>

  <div class="table-wrapper">
    <table class="prob-table">
      <thead>
        <tr>
          <th>k (aantal juist)</th>
          <th>P(X = k)</th>
          <th>P(X &ge; k) toeval</th>
          <th>Kans op wijnkennis</th>
        </tr>
      </thead>
      <tbody id="prob-tbody"></tbody>
    </table>
  </div>
</div>

<script>generateProbTable();</script>

</body>
</html>
